generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id // Firebase UID
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  jobTitle  String?
  avatarUrl String?
  
  accounts  SocialAccount[]
  posts     Post[]
  projects  Project[]
  personas  Persona[]
  tickets   Ticket[]
  subscription Subscription?
  competitors Competitor[]
  integrations Integration[]
  aiGenerations AiGeneration[]

  workspaceMemberships WorkspaceMember[]

  @@index([email])
}

model Workspace {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  ownerId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members   WorkspaceMember[]
}

model WorkspaceMember {
  id          String   @id @default(uuid())
  role        String   @default("MEMBER") // OWNER, ADMIN, MEMBER, VIEWER
  userId      String
  workspaceId String
  
  user        User      @relation(fields: [userId], references: [id])
  workspace   Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([userId, workspaceId])
  @@index([userId])
  @@index([workspaceId])
}


model SocialAccount {
  id             String   @id @default(uuid())
  provider       String
  platformUserId String
  username       String?
  accessToken    String
  refreshToken   String?
  expiresAt      DateTime?
  user           User     @relation(fields: [userId], references: [id])
  userId         String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([provider, platformUserId])
  @@index([userId])
}

model Project {
  id          String   @id @default(uuid())
  name        String
  description String?
  platforms   String   // JSON string of selected platforms
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  posts       Post[]
  createdAt   DateTime @default(now())
  
  @@index([userId])
}

model Persona {
  id          String   @id @default(uuid())
  name        String
  avatarUrl   String?
  tone        String
  variables   String   // JSON string: { "signature": "...", "intro": "..." }
  isGlobal    Boolean  @default(false) // Reusable across projects
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  createdAt   DateTime @default(now())

  @@index([userId])
}

model Post {
  id          String   @id @default(uuid())
  content     String
  mediaUrl    String?
  platform    String
  scheduledAt DateTime?
  status      String   @default("DRAFT")
  
  // Platform specific options stored as JSON
  options     String?  // { "hashtags": [], "subreddit": "...", "emailSubject": "..." }
  
  // Feature: Omni-Post
  groupId     String?  @default(uuid()) // Links variants together

  // Feature: Automations
  autoPlugEnabled   Boolean @default(false)
  autoPlugThreshold Int     @default(50)
  autoPlugContent   String?
  
  autoDmEnabled     Boolean @default(false)
  autoDmKeyword     String?
  autoDmContent     String?

  user        User     @relation(fields: [userId], references: [id])
  userId      String
  
  project     Project? @relation(fields: [projectId], references: [id])
  projectId   String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt @default(now())

  @@index([userId])
  @@index([status, scheduledAt])
  @@index([groupId])
}

model Ticket {
  id        String   @id @default(uuid())
  subject   String
  message   String
  status    String   @default("OPEN") // OPEN, PENDING, CLOSED
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  createdAt DateTime @default(now())

  @@index([userId])
}

model Subscription {
  id        String   @id @default(uuid())
  plan      String   @default("FREE")
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @unique
}

model Competitor {
  id        String   @id @default(uuid())
  handle    String
  status    String   @default("Active Now")
  lastPost  String   @default("Just now")
  // Feature: Competitor Spyglass
  analysis  String?  // JSON: { "bestTime": "09:00", "hashtags": [], "heatmap": ... }
  
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  createdAt DateTime @default(now())

  @@index([userId])
}

model Integration {
  id          String   @id @default(uuid())
  type        String   // "NOTION", etc.
  config      String   // JSON: { "databaseId": "...", "accessToken": "..." }
  lastSyncedAt DateTime?
  
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, type])
}

model Article {
  id          Int      @id @default(autoincrement())
  title       String
  category    String
  time        String
  description String
  content     String   // Stores rich HTML
  imageUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AiGeneration {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
}
